#!/bin/bash

# Author: Emiliano Sauvisky
# Name: takeScreenshot
# Description: Takes a screenshot of the entire screen with scrot and edits or upload it.
#              If user chooses to edit the screenshot and it's original file is overwritten (CTRL+S),
#              it's uploaded nevertheless. Upload link also goes straight to clipboard.

# Changelog
# 3-nov-2016: removido scrot, porque o wayland nao suporta que apps capturem a janela root
#             comentadas opções de upload porque não são mais usadas


# Checking requirements
# soft[0]="scrot"
soft[0]="gnome-screenshot"
soft[1]="gimp"
soft[2]="emiliano-imgupload"
soft[3]="xclip"
soft[4]="zenity"
for check in ${soft[@]}; do hash $check &>/dev/null || { echo >&2 "ERROR: $check doesn't exists in $PATH."; exit 1; }; done
# Done

option=$(zenity --list --title="Opções de captura de tela" --text="O que deseja fazer?" --hide-header --column= \
    "Editar PNG 100 no GIMP" \
    "Editar JPG 85 no GIMP" ) #"Upload JPG 85" )
echo ":$option:"
case $option in
    "Editar PNG 100 no GIMP")
        _oldmd5=$(md5sum "$file" | sed 's/ .*//')
        gimp "$file"
        _newmd5=$(md5sum "$file" | sed 's/ .*//')
        #if [[ $_oldmd5 != $_newmd5 ]]; then zenity --question --text="Deseja fazer upload da imagem?" && upload=true; fi
        ;;
    "Editar JPG 85 no GIMP")
        convert "$file" -quality 85 "${file%.png}".jpg
        rm "$file"
        file="${file%.png}".jpg
        _oldmd5=$(md5sum "$file" | sed 's/ .*//')
        gimp "$file"
        _newmd5=$(md5sum "$file" | sed 's/ .*//')
        #if [[ $_oldmd5 != $_newmd5 ]]; then zenity --question --text="Deseja fazer upload da imagem?" && upload=true; fi
        ;;
    "Upload JPG 85")
        convert "$file" -quality 85 "${file%.png}".jpg
        rm "$file"
        file="${file%.png}".jpg
        du -s "$file"
        upload=true
        ;;
    *)
        exit 1
        ;;
esac

if [[ $upload ]]; then
    links=$(emiliano-imgupload "$file")
    echo -n "$links" | xclip -selection clipboard
    zenity --info --no-wrap --text="Upload link copied to clipboard."
else
    echo -n "$file" | xclip -selection clipboard
fi
